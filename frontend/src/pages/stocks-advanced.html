<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VittCott â€” Advanced Stock Market</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .stock-card { 
      transition: all 0.3s ease; 
      cursor: pointer;
    }
    .stock-card:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
      border-color: rgb(99, 102, 241);
    }
    .price-up { animation: priceUp 0.6s ease; }
    .price-down { animation: priceDown 0.6s ease; }
    @keyframes priceUp { 0% { background-color: rgba(34, 197, 94, 0.3); } 100% { background-color: transparent; } }
    @keyframes priceDown { 0% { background-color: rgba(239, 68, 68, 0.3); } 100% { background-color: transparent; } }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      animation: fadeIn 0.3s;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .chart-container {
      position: relative;
      height: 400px;
    }
    
    .api-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .api-massive {
      background: linear-gradient(to right, #8b5cf6, #ec4899);
      color: white;
    }
    
    .api-finnhub {
      background: linear-gradient(to right, #3b82f6, #06b6d4);
      color: white;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">
  <!-- Navigation -->
  <nav class="bg-gray-800 p-4 sticky top-0 z-50 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
      <a href="/" class="text-xl font-bold text-indigo-400">VittCott</a>
      <div class="flex gap-4 items-center">
        <a href="/" class="hover:text-indigo-400 transition">Home</a>
        <a href="/pages/mutual-funds.html" class="hover:text-indigo-400 transition">Mutual Funds</a>
        <a href="/pages/ai-assistant.html" class="bg-gradient-to-r from-purple-500 to-pink-500 px-4 py-2 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          Ask AI
        </a>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
          Advanced Stock Market
        </h1>
        <p class="text-gray-400">Real-time data powered by Massive API â€¢ Auto-refresh every 10 seconds</p>
      </div>
      <div id="api-status-badge"></div>
    </div>

    <!-- Market Status Bar -->
    <div class="mb-6 bg-gradient-to-r from-gray-800 to-gray-700 p-4 rounded-lg shadow-xl flex justify-between items-center">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <div id="market-indicator" class="w-3 h-3 rounded-full pulse"></div>
          <span id="market-status" class="font-semibold">Loading...</span>
        </div>
        <div class="text-sm text-gray-400">
          Last updated: <span id="last-updated">--:--:--</span>
        </div>
      </div>
      <div class="flex gap-3">
        <button id="refresh-btn" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh
        </button>
        <button id="view-toggle" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition">
          Grid View
        </button>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
      <div class="relative">
        <input 
          type="text" 
          id="search-input"
          placeholder="Search stocks by symbol or name (e.g., AAPL, Tesla)..."
          class="w-full bg-gray-800 text-white px-4 py-3 pl-12 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        <svg class="w-6 h-6 absolute left-4 top-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
      <div id="search-results" class="mt-2"></div>
    </div>

    <!-- Filter Chips -->
    <div class="mb-6 flex gap-3 overflow-x-auto pb-2">
      <button class="filter-chip active" data-filter="all">All Stocks</button>
      <button class="filter-chip" data-filter="gainers">Top Gainers</button>
      <button class="filter-chip" data-filter="losers">Top Losers</button>
      <button class="filter-chip" data-filter="tech">Tech Stocks</button>
      <button class="filter-chip" data-filter="volume">High Volume</button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-12">
      <div class="inline-block w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-4 text-gray-400">Loading stock data...</p>
    </div>

    <!-- Stocks Grid -->
    <div id="stocks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
      <!-- Stock cards will be inserted here -->
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-900/20 border border-red-500 rounded-lg p-6 text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 class="text-xl font-bold mb-2">Failed to load stock data</h3>
      <p class="text-gray-400" id="error-message"></p>
      <button onclick="location.reload()" class="mt-4 bg-indigo-600 hover:bg-indigo-700 px-6 py-2 rounded-lg transition">
        Try Again
      </button>
    </div>
  </main>

  <!-- Stock Detail Modal -->
  <div id="stock-modal" class="modal">
    <div class="bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-800 z-10">
        <div>
          <h2 id="modal-title" class="text-2xl font-bold"></h2>
          <p id="modal-subtitle" class="text-gray-400"></p>
        </div>
        <button id="close-modal" class="text-gray-400 hover:text-white transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <!-- Price Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-gray-700 p-4 rounded-lg">
            <div class="text-sm text-gray-400">Current Price</div>
            <div id="modal-price" class="text-2xl font-bold"></div>
          </div>
          <div class="bg-gray-700 p-4 rounded-lg">
            <div class="text-sm text-gray-400">Change</div>
            <div id="modal-change" class="text-2xl font-bold"></div>
          </div>
          <div class="bg-gray-700 p-4 rounded-lg">
            <div class="text-sm text-gray-400">Volume</div>
            <div id="modal-volume" class="text-xl font-bold"></div>
          </div>
          <div class="bg-gray-700 p-4 rounded-lg">
            <div class="text-sm text-gray-400">VWAP</div>
            <div id="modal-vwap" class="text-xl font-bold"></div>
          </div>
        </div>

        <!-- Chart Timeframe Selector -->
        <div class="mb-4 flex gap-2">
          <button class="chart-timeframe-btn active" data-timespan="day" data-range="5">5D</button>
          <button class="chart-timeframe-btn" data-timespan="day" data-range="30">1M</button>
          <button class="chart-timeframe-btn" data-timespan="week" data-range="12">3M</button>
          <button class="chart-timeframe-btn" data-timespan="month" data-range="6">6M</button>
          <button class="chart-timeframe-btn" data-timespan="month" data-range="12">1Y</button>
        </div>

        <!-- Chart -->
        <div class="chart-container bg-gray-700 rounded-lg p-4 mb-6">
          <canvas id="stock-chart"></canvas>
        </div>

        <!-- Additional Stats -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <div class="text-sm text-gray-400">Open</div>
            <div id="modal-open" class="text-lg font-semibold"></div>
          </div>
          <div>
            <div class="text-sm text-gray-400">Previous Close</div>
            <div id="modal-prev-close" class="text-lg font-semibold"></div>
          </div>
          <div>
            <div class="text-sm text-gray-400">Day High</div>
            <div id="modal-high" class="text-lg font-semibold"></div>
          </div>
          <div>
            <div class="text-sm text-gray-400">Day Low</div>
            <div id="modal-low" class="text-lg font-semibold"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .filter-chip {
      @apply px-4 py-2 rounded-full bg-gray-800 text-gray-300 hover:bg-gray-700 transition whitespace-nowrap;
    }
    .filter-chip.active {
      @apply bg-indigo-600 text-white;
    }
    .chart-timeframe-btn {
      @apply px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition;
    }
    .chart-timeframe-btn.active {
      @apply bg-indigo-600;
    }
  </style>

  <script>
    let allStocks = [];
    let currentFilter = 'all';
    let refreshInterval;
    let currentChart = null;
    let currentSymbol = null;

    // Initialize
    AOS.init();
    fetchStocks();
    checkAPIStatus();

    // Auto-refresh every 10 seconds
    refreshInterval = setInterval(fetchStocks, 10000);

    // Fetch stocks data
    async function fetchStocks() {
      try {
        const response = await fetch('/api/stocks/live');
        const data = await response.json();
        
        allStocks = data.stocks;
        displayStocks(allStocks);
        updateMarketStatus(data.marketOpen);
        updateLastUpdated();
        hideLoading();
      } catch (error) {
        showError('Unable to fetch stock data. Please try again later.');
        console.error('Error:', error);
      }
    }

    // Check API status
    async function checkAPIStatus() {
      try {
        const response = await fetch('/api/stocks/api-status');
        const status = await response.json();
        
        const badge = document.getElementById('api-status-badge');
        const apiClass = status.primaryAPI === 'Massive' ? 'api-massive' : 'api-finnhub';
        const icon = status.fallbackAvailable ? 'ðŸ”„' : 'âš¡';
        
        badge.className = 'api-badge ' + apiClass;
        badge.innerHTML = `${icon} ${status.primaryAPI} API ${status.fallbackAvailable ? '(with fallback)' : ''}`;
      } catch (error) {
        console.error('Failed to check API status:', error);
      }
    }

    // Display stocks
    function displayStocks(stocks) {
      const container = document.getElementById('stocks-container');
      
      let filteredStocks = filterStocks(stocks);
      
      container.innerHTML = filteredStocks.map(stock => createStockCard(stock)).join('');
      
      // Add click listeners
      document.querySelectorAll('.stock-card').forEach(card => {
        card.addEventListener('click', () => {
          const symbol = card.dataset.symbol;
          showStockDetails(symbol);
        });
      });
    }

    // Filter stocks
    function filterStocks(stocks) {
      switch(currentFilter) {
        case 'gainers':
          return stocks.filter(s => s.change > 0).sort((a, b) => b.change - a.change);
        case 'losers':
          return stocks.filter(s => s.change < 0).sort((a, b) => a.change - b.change);
        case 'tech':
          const techSymbols = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA', 'NFLX', 'ADBE'];
          return stocks.filter(s => techSymbols.includes(s.symbol));
        case 'volume':
          return stocks.filter(s => s.volume > 0).sort((a, b) => b.volume - a.volume);
        default:
          return stocks;
      }
    }

    // Create stock card
    function createStockCard(stock) {
      const changeClass = stock.change >= 0 ? 'text-green-400' : 'text-red-400';
      const changeIcon = stock.change >= 0 ? 'â–²' : 'â–¼';
      const volumeFormatted = stock.volume > 0 ? (stock.volume / 1000000).toFixed(2) + 'M' : 'N/A';
      
      return `
        <div class="stock-card bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-indigo-500" data-symbol="${stock.symbol}" data-aos="fade-up">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-xl font-bold">${stock.symbol}</h3>
              <p class="text-sm text-gray-400">${stock.name}</p>
            </div>
            <span class="text-xs px-2 py-1 rounded ${stock.source === 'Massive API' ? 'bg-purple-600' : 'bg-blue-600'}">
              ${stock.source === 'Massive API' ? 'Massive' : 'FinHub'}
            </span>
          </div>
          
          <div class="mb-4">
            <div class="text-3xl font-bold mb-1">$${stock.price.toFixed(2)}</div>
            <div class="${changeClass} flex items-center gap-1 text-lg font-semibold">
              ${changeIcon} ${Math.abs(stock.change).toFixed(2)}%
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <div class="text-gray-400">High</div>
              <div class="font-semibold">${stock.high}</div>
            </div>
            <div>
              <div class="text-gray-400">Low</div>
              <div class="font-semibold">${stock.low}</div>
            </div>
            <div>
              <div class="text-gray-400">Volume</div>
              <div class="font-semibold">${volumeFormatted}</div>
            </div>
            <div>
              <div class="text-gray-400">VWAP</div>
              <div class="font-semibold">${stock.vwap > 0 ? '$' + stock.vwap : 'N/A'}</div>
            </div>
          </div>
          
          <div class="mt-4 pt-4 border-t border-gray-700 text-xs text-gray-500 flex justify-between">
            <span>Open: $${stock.open}</span>
            <span>Prev: $${stock.previousClose}</span>
          </div>
        </div>
      `;
    }

    // Show stock details modal
    async function showStockDetails(symbol) {
      currentSymbol = symbol;
      const stock = allStocks.find(s => s.symbol === symbol);
      
      if (!stock) return;
      
      // Update modal content
      document.getElementById('modal-title').textContent = stock.symbol;
      document.getElementById('modal-subtitle').textContent = stock.name;
      document.getElementById('modal-price').textContent = '$' + stock.price.toFixed(2);
      
      const changeClass = stock.change >= 0 ? 'text-green-400' : 'text-red-400';
      document.getElementById('modal-change').className = 'text-2xl font-bold ' + changeClass;
      document.getElementById('modal-change').textContent = (stock.change >= 0 ? '+' : '') + stock.change.toFixed(2) + '%';
      
      document.getElementById('modal-volume').textContent = stock.volume > 0 ? (stock.volume / 1000000).toFixed(2) + 'M' : 'N/A';
      document.getElementById('modal-vwap').textContent = stock.vwap > 0 ? '$' + stock.vwap : 'N/A';
      document.getElementById('modal-open').textContent = '$' + stock.open;
      document.getElementById('modal-prev-close').textContent = '$' + stock.previousClose;
      document.getElementById('modal-high').textContent = '$' + stock.high;
      document.getElementById('modal-low').textContent = '$' + stock.low;
      
      // Show modal
      document.getElementById('stock-modal').classList.add('active');
      
      // Load chart
      loadChart(symbol, 'day', '5');
    }

    // Load chart data
    async function loadChart(symbol, timespan, range) {
      try {
        const response = await fetch(`/api/stocks/chart/${symbol}?timespan=${timespan}&range=${range}`);
        const data = await response.json();
        
        const ctx = document.getElementById('stock-chart').getContext('2d');
        
        // Destroy existing chart
        if (currentChart) {
          currentChart.destroy();
        }
        
        currentChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.data.map(d => d.date),
            datasets: [{
              label: 'Price',
              data: data.data.map(d => d.close),
              borderColor: 'rgb(99, 102, 241)',
              backgroundColor: 'rgba(99, 102, 241, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                ticks: {
                  color: 'rgb(156, 163, 175)',
                  callback: function(value) {
                    return '$' + value.toFixed(2);
                  }
                },
                grid: {
                  color: 'rgba(75, 85, 99, 0.3)'
                }
              },
              x: {
                ticks: {
                  color: 'rgb(156, 163, 175)',
                  maxTicksLimit: 8
                },
                grid: {
                  color: 'rgba(75, 85, 99, 0.3)'
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Failed to load chart:', error);
      }
    }

    // Event Listeners
    document.getElementById('close-modal').addEventListener('click', () => {
      document.getElementById('stock-modal').classList.remove('active');
      if (currentChart) {
        currentChart.destroy();
        currentChart = null;
      }
    });

    document.getElementById('refresh-btn').addEventListener('click', fetchStocks);

    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        displayStocks(allStocks);
      });
    });

    document.querySelectorAll('.chart-timeframe-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chart-timeframe-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadChart(currentSymbol, btn.dataset.timespan, btn.dataset.range);
      });
    });

    // Search functionality
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        document.getElementById('search-results').innerHTML = '';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/stocks/search/${query}`);
          const data = await response.json();
          
          const resultsHtml = data.results.map(stock => `
            <div class="bg-gray-800 p-3 rounded hover:bg-gray-700 cursor-pointer mb-2" onclick="searchStockClick('${stock.symbol}')">
              <div class="font-bold">${stock.symbol}</div>
              <div class="text-sm text-gray-400">${stock.name}</div>
            </div>
          `).join('');
          
          document.getElementById('search-results').innerHTML = resultsHtml || '<div class="text-gray-500 p-3">No results found</div>';
        } catch (error) {
          console.error('Search failed:', error);
        }
      }, 300);
    });

    function searchStockClick(symbol) {
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';
      showStockDetails(symbol);
    }

    // Utility functions
    function updateMarketStatus(isOpen) {
      const indicator = document.getElementById('market-indicator');
      const status = document.getElementById('market-status');
      
      if (isOpen) {
        indicator.className = 'w-3 h-3 rounded-full bg-green-500 pulse';
        status.textContent = 'Market Open';
        status.className = 'font-semibold text-green-400';
      } else {
        indicator.className = 'w-3 h-3 rounded-full bg-red-500';
        status.textContent = 'Market Closed';
        status.className = 'font-semibold text-red-400';
      }
    }

    function updateLastUpdated() {
      const now = new Date();
      document.getElementById('last-updated').textContent = now.toLocaleTimeString();
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('stocks-container').classList.remove('hidden');
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
    }
  </script>
</body>
</html>
